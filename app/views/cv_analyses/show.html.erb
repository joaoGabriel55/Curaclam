<div class="container">
  <header class="page-header">
    <h1>CV Analysis Dashboard</h1>
    <%= link_to "‚Üê Back to All Analyses", cv_analyses_path, class: "btn btn-secondary" %>
  </header>

  <% if notice.present? %>
    <div class="alert alert-success">
      <%= notice %>
    </div>
  <% end %>

  <div class="analysis-header">
    <div class="analysis-file-info">
      <% if @cv_analysis.cv_file.attached? %>
        <span class="file-icon">üìÑ</span>
        <span class="file-name"><%= @cv_analysis.cv_file.filename %></span>
      <% end %>
      <span class="status-badge status-<%= @cv_analysis.status %>">
        <%= @cv_analysis.status.titleize %>
      </span>
    </div>
    <div class="analysis-meta">
      Uploaded <%= time_ago_in_words(@cv_analysis.created_at) %> ago
    </div>
  </div>

  <% if @cv_analysis.pending? || @cv_analysis.processing? %>
    <div class="processing-state">
      <div class="spinner"></div>
      <h3>Analyzing your CV...</h3>
      <p>This may take a few moments. The page will update automatically when complete.</p>
      <p class="refresh-hint">
        <%= link_to "Refresh page", cv_analysis_path(@cv_analysis), class: "btn btn-secondary btn-sm" %>
      </p>
    </div>

    <script>
      // Auto-refresh every 5 seconds while processing
      setTimeout(function() {
        window.location.reload();
      }, 5000);
    </script>

  <% elsif @cv_analysis.failed? %>
    <div class="error-state">
      <div class="error-icon">‚ùå</div>
      <h3>Analysis Failed</h3>
      <p><%= @cv_analysis.error_message %></p>
      <div class="error-actions">
        <%= link_to "Try Again", new_cv_analysis_path, class: "btn btn-primary" %>
        <%= button_to "Delete", cv_analysis_path(@cv_analysis), method: :delete, class: "btn btn-danger", data: { turbo_confirm: "Are you sure?" } %>
      </div>
    </div>

  <% elsif @cv_analysis.completed? && @cv_analysis.has_results? %>
    <% result = @cv_analysis.parsed_result %>

    <div class="dashboard-grid">
      <!-- Personal Information Section -->
      <% if result["personal_info"].present? %>
        <section class="dashboard-section personal-info-section">
          <h2><span class="section-icon">üë§</span> Personal Information</h2>
          <div class="info-grid">
            <% personal = result["personal_info"] %>
            <% if personal["name"].present? %>
              <div class="info-item">
                <span class="info-label">Name</span>
                <span class="info-value"><%= personal["name"] %></span>
              </div>
            <% end %>
            <% if personal["email"].present? %>
              <div class="info-item">
                <span class="info-label">Email</span>
                <span class="info-value"><%= mail_to personal["email"] %></span>
              </div>
            <% end %>
            <% if personal["phone"].present? %>
              <div class="info-item">
                <span class="info-label">Phone</span>
                <span class="info-value"><%= personal["phone"] %></span>
              </div>
            <% end %>
            <% if personal["location"].present? %>
              <div class="info-item">
                <span class="info-label">Location</span>
                <span class="info-value"><%= personal["location"] %></span>
              </div>
            <% end %>
            <% if personal["linkedin"].present? %>
              <div class="info-item">
                <span class="info-label">LinkedIn</span>
                <span class="info-value"><%= link_to personal["linkedin"], personal["linkedin"], target: "_blank" %></span>
              </div>
            <% end %>
            <% if personal["portfolio"].present? %>
              <div class="info-item">
                <span class="info-label">Portfolio</span>
                <span class="info-value"><%= link_to personal["portfolio"], personal["portfolio"], target: "_blank" %></span>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>

      <!-- Summary Section -->
      <% if result["summary"].present? %>
        <section class="dashboard-section summary-section">
          <h2><span class="section-icon">üìù</span> Professional Summary</h2>
          <p class="summary-text"><%= result["summary"] %></p>
        </section>
      <% end %>

      <!-- Skills Section -->
      <% if result["skills"].present? %>
        <section class="dashboard-section skills-section">
          <h2><span class="section-icon">üõ†Ô∏è</span> Skills</h2>
          <div class="skills-grid">
            <% skills = result["skills"] %>
            <% if skills["technical"].present? && skills["technical"].any? %>
              <div class="skill-category">
                <h4>Technical Skills</h4>
                <div class="skill-tags">
                  <% skills["technical"].each do |skill| %>
                    <span class="skill-tag technical"><%= skill %></span>
                  <% end %>
                </div>
              </div>
            <% end %>
            <% if skills["soft_skills"].present? && skills["soft_skills"].any? %>
              <div class="skill-category">
                <h4>Soft Skills</h4>
                <div class="skill-tags">
                  <% skills["soft_skills"].each do |skill| %>
                    <span class="skill-tag soft"><%= skill %></span>
                  <% end %>
                </div>
              </div>
            <% end %>
            <% if skills["languages"].present? && skills["languages"].any? %>
              <div class="skill-category">
                <h4>Languages</h4>
                <div class="skill-tags">
                  <% skills["languages"].each do |lang| %>
                    <span class="skill-tag language"><%= lang %></span>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>

      <!-- Experience Section -->
      <% if result["experience"].present? && result["experience"].any? %>
        <section class="dashboard-section experience-section">
          <h2><span class="section-icon">üíº</span> Work Experience</h2>
          <div class="timeline">
            <% result["experience"].each do |exp| %>
              <div class="timeline-item">
                <div class="timeline-header">
                  <h4 class="timeline-title"><%= exp["title"] %></h4>
                  <span class="timeline-company"><%= exp["company"] %></span>
                </div>
                <span class="timeline-period"><%= exp["period"] %></span>
                <% if exp["description"].present? %>
                  <p class="timeline-description"><%= exp["description"] %></p>
                <% end %>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>

      <!-- Education Section -->
      <% if result["education"].present? && result["education"].any? %>
        <section class="dashboard-section education-section">
          <h2><span class="section-icon">üéì</span> Education</h2>
          <div class="timeline">
            <% result["education"].each do |edu| %>
              <div class="timeline-item">
                <div class="timeline-header">
                  <h4 class="timeline-title"><%= edu["degree"] %></h4>
                  <span class="timeline-company"><%= edu["institution"] %></span>
                </div>
                <span class="timeline-period"><%= edu["year"] %></span>
                <% if edu["details"].present? %>
                  <p class="timeline-description"><%= edu["details"] %></p>
                <% end %>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>

      <!-- Certifications Section -->
      <% if result["certifications"].present? && result["certifications"].any? %>
        <section class="dashboard-section certifications-section">
          <h2><span class="section-icon">üèÖ</span> Certifications</h2>
          <ul class="certifications-list">
            <% result["certifications"].each do |cert| %>
              <li><%= cert %></li>
            <% end %>
          </ul>
        </section>
      <% end %>

      <!-- Highlights Section -->
      <% if result["highlights"].present? && result["highlights"].any? %>
        <section class="dashboard-section highlights-section">
          <h2><span class="section-icon">‚≠ê</span> Key Highlights</h2>
          <ul class="highlights-list">
            <% result["highlights"].each do |highlight| %>
              <li><%= highlight %></li>
            <% end %>
          </ul>
        </section>
      <% end %>

      <!-- Recommendations Section -->
      <% if result["recommendations"].present? && result["recommendations"].any? %>
        <section class="dashboard-section recommendations-section">
          <h2><span class="section-icon">üí°</span> Recommendations for Improvement</h2>
          <ul class="recommendations-list">
            <% result["recommendations"].each do |rec| %>
              <li><%= rec %></li>
            <% end %>
          </ul>
        </section>
      <% end %>
    </div>

    <!-- Raw Text Section (Collapsible) -->
    <% if @cv_analysis.extracted_text.present? %>
      <details class="extracted-text-section">
        <summary>View Extracted Text</summary>
        <pre class="extracted-text"><%= @cv_analysis.extracted_text %></pre>
      </details>
    <% end %>

  <% else %>
    <div class="empty-state">
      <div class="empty-state-icon">üîç</div>
      <h3>No Analysis Results</h3>
      <p>Something went wrong. Please try uploading your CV again.</p>
      <%= link_to "Upload New CV", new_cv_analysis_path, class: "btn btn-primary" %>
    </div>
  <% end %>
</div>
